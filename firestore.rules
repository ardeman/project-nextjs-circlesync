rules_version = '2';

service cloud.firestore {
  function isOwner(owner) {
    return owner == request.auth.uid;
  }

  function isAuthenticated() {
    return request.auth != null;
  }

  function isRegistered() {
    return exists(/databases/$(database)/documents/users/$(request.auth.uid));
  }

  function isCollaborator(collaborators) {
    return collaborators.hasAny(request.auth.uid)
  }

  function isSpectator(spectators) {
    return spectators.hasAny(request.auth.uid)
  }

  match /databases/{database}/documents {

    // Users collection rules
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwner(userId);
    }

    // Groups collection rules
    match /groups/{groupId} {
      allow delete: if isOwner(resource.data.owner);
      allow create, read: if isRegistered();
      allow write: if isCollaborator(resource.data.collaborators);
    }

    // Notes collection rules
    match /notes/{noteId} {
      allow delete: if isOwner(resource.data.owner);
      allow create: if isRegistered();
      allow read: if isSpectator(resource.data.spectators) || isCollaborator(resource.data.collaborators) || isOwner(resource.data.owner);
      allow write: if isCollaborator(resource.data.collaborators) || isOwner(resource.data.owner);
    }

    // To-Dos collection rules
    match /to-dos/{todoId} {
      allow delete: if isOwner(resource.data.owner);
      allow create: if isRegistered();
      allow read: if isSpectator(resource.data.spectators) || isCollaborator(resource.data.collaborators) || isOwner(resource.data.owner);
      allow write: if isCollaborator(resource.data.collaborators) || isOwner(resource.data.owner);
    }

    // Reminders collection rules
    match /reminders/{reminderId} {
      allow delete: if isOwner(resource.data.owner);
      allow create: if isRegistered();
      allow read: if isSpectator(resource.data.spectators) || isCollaborator(resource.data.collaborators) || isOwner(resource.data.owner);
      allow write: if isCollaborator(resource.data.collaborators) || isOwner(resource.data.owner);
    }

    // Money Log collection rules
    match /money-logs/{moneyLogId} {
      allow delete: if isOwner(resource.data.owner);
      allow create: if isRegistered();
      allow read: if isSpectator(resource.data.spectators) || isCollaborator(resource.data.collaborators) || isOwner(resource.data.owner);
      allow write: if isCollaborator(resource.data.collaborators) || isOwner(resource.data.owner);
    }
  }
}
